#!/bin/bash

# layout files
Menu_LAYOUTINIT="${L}/menu.bl.init"
Menu_LAYOUT="${L}/menu.bl"

this.quit()
{
    APPSTATE=$AppState_STOP
}

this.showDefault()
{
    cat "$Menu_LAYOUT"
}

this.init()
{
    # dapat same ung menu.bl at menu.bl.init
    if ! diff "$Menu_LAYOUT" "$Menu_LAYOUTINIT"; then
        cp "$Menu_LAYOUTINIT" "$Menu_LAYOUT"
        log "Menu - Copying Initial Layout..."
    fi
    log "Menu - Initialized..."
}

this.showMenuItem()
{
    case $MENUSTATE in
        $MenuState_ADD)
            APPSTATE=$AppState_ADD;;
        $MenuState_EDIT)
            APPSTATE=$AppState_EDIT;;
        $MenuState_DELETE)
            APPSTATE=$AppState_DELETE;;
        $MenuState_VIEW)
            APPSTATE=$AppState_VIEW;;
        $MenuState_LOAD)
            APPSTATE=$AppState_LOAD;;
        $MenuState_QUIT)
            this.quit;;
        *)
            log "Menu - showMenuItem() - Invalid Menu State...";;
    esac
}

this.readKey()
{
    # reads 1 character only and silent mode
    read -s -n1 KEY
    case $KEY in
        [qQ]) # From menu, press q to quit
            this.quit
        ;;
        [wW]) # Up
            if [ $MENUSTATE -gt $(( $MenuState_NULL + 1 )) ]; then
                (( MENUSTATE-= 1 ))
            fi
        ;;
        [sS]) # Down
            if [ $MENUSTATE -lt $(( $MenuState_NUM - 1 )) ]; then
                (( MENUSTATE+= 1 ))
            fi
        ;;
        "") # Enter
            this.showMenuItem
            # echo "You Entered ${MENUSTATE}"
        ;;
        *)
            log "Menu - this.readKey() - Invalid Key..."
        ;;
    esac
}

this.update()
{
    clear

    # pag 0, walang selected, so ung default lng.
    if [ $MENUSTATE -eq 0 ]; then
        this.showDefault
        return 0
    fi

    # update ung display nung Menu
    local CHAR="~"        # to indicate na selected
    local LINEHEIGHT=3
    local LINEEND=$(( 4 * $MENUSTATE ))
    local HEADER=$(( $LINEEND - $LINEHEIGHT ))

    local LINETOTAL=$(cat "$Menu_LAYOUT" | wc -l)
    local TAILER=$(( $LINETOTAL - $LINEEND ))

    head -$HEADER "$Menu_LAYOUT"
    head -$LINEEND "$Menu_LAYOUT" | tail -$LINEHEIGHT | tr " " $CHAR
    tail -$TAILER "$Menu_LAYOUT"
    # echo "APPSTATE = ${APPSTATE} || MENUSTATE = ${MENUSTATE}"
}

Menu.Show()
{
    # eto ung display
    this.init
    this.showDefault

    # While nasa menu yung application
    while [ $APPSTATE -eq $AppState_MENU ]; do
        this.readKey
        this.update
    done
}

Menu.PressKeyToMenu()
{
    echo -n "Press any key to go back to menu..."
    read -s -n1
    APPSTATE=$AppState_MENU
}
